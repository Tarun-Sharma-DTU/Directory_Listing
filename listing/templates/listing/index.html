{% extends "listing/base.html" %}

{% block title %}Directory Listing Automation{% endblock %}

{% block content %}
<form id="uploadForm" method="post" action="{% url 'home' %}" enctype="multipart/form-data" class="mb-4">
    {% csrf_token %}
    <div class="row g-3">
        <div class="col-md-3">
            <label for="excel_file" class="form-label">Select an Excel file</label>
            <input type="file" class="form-control" name="excel_file" id="excel_file">
        </div>
        <div class="col-md-3">
            <label for="site_number" class="form-label">Number Of Sites</label>
            <input type="number" class="form-control" name="site_number" id="site_number" placeholder="Enter Site Number">
        </div>
    </div>
    <div class="col-md-3 mt-3">
        <div class="form-check">
            <input class="form-check-input" type="checkbox" value="" id="avoidDuplication" name="avoid_duplication">
            <label class="form-check-label" for="avoidDuplication">
                Avoid Duplication Business Name
            </label>
        </div>
    </div>
    <div class="row mt-3">
        <div class="col">
            <button type="button" id="startProcess" class="btn btn-primary" style="background-color: #a453ca;">Start Posting</button>
        </div>
        <div class="col">
            <button type="button" id="stopProcess" class="btn btn-danger mt-4">Stop Process</button>
        </div>
    </div>
    <div>
        <a href="{% url 'download_excel' %}" class="btn btn-success">Download Latest Report</a>
    </div>
</form>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('startProcess').addEventListener('click', function(event) {
            event.preventDefault(); 
            let siteNumber = document.getElementById('site_number').value;
            let excelFile = document.getElementById('excel_file').files.length;

            if (excelFile === 0) {
                alert('Please upload an Excel file.');
                return;
            }
            
            if (siteNumber === '' || isNaN(siteNumber) || parseInt(siteNumber) <= 0) {
                alert('Please enter a valid site number.');
                return;
            }

            clearTable();
    
            let form = document.getElementById('uploadForm');
            let formData = new FormData(form);
    
            console.log("Form submitted, awaiting task IDs...");
    
            fetch('{% url "home" %}', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.task_ids && data.task_ids.length > 0) {
                    console.log("Received task IDs:", data.task_ids);
                    let completedTasks = 0;
                    let failedTasks = 0;
                    data.task_ids.forEach(taskId => {
                        checkTaskStatus(taskId, (status) => {
                            if (status === 'SUCCESS') {
                                completedTasks++;
                            } else {
                                // Increment failedTasks for 'FAILURE' or 'ERROR'
                                failedTasks++;
                            }
                            
                            // Check if all tasks have been processed
                            if (completedTasks + failedTasks === data.task_ids.length) {
                                alert("All tasks have been processed.");
                                fetchGeneratedLinks();
                            }
                        });
                    });
                } else {
                    console.error('Form submission did not return task IDs');
                }
            })
            .catch(error => console.error('Error:', error));
        });

    
        function checkTaskStatus(taskId, onComplete) {
            fetch(`/get-task-result/${taskId}/`)
                .then(response => response.json())
                .then(data => {
                    console.log(`Status for task ${taskId}:`, data);
                    if (data.status === 'SUCCESS' || data.status === 'FAILURE' || data.status === 'ERROR') {
                        if (data.status === 'SUCCESS') {
                            addLinkToTable(data.url);
                        }
                        onComplete(data.status); // Call onComplete regardless of task status
                    } else if (data.status === 'PENDING') {
                        // If task is still pending, check again after a delay
                        setTimeout(() => checkTaskStatus(taskId, onComplete), 2000);
                    }
                })
                .catch(error => console.error('Error:', error));
        }

        function addLinkToTable(url) {
            let tableBody = document.querySelector('#linksTable tbody');
            console.log("Current row count before adding:", tableBody.rows.length); // For debugging
            let row = tableBody.insertRow();
            let cellNumber = row.insertCell(0);
            let cellLink = row.insertCell(1);
            cellNumber.textContent = tableBody.rows.length; // This should now be the new row count after insertion
            cellLink.innerHTML = `<a href="${url}" target="_blank">${url}</a>`;
        }
                
        function fetchGeneratedLinks() {
            fetch('/get-generated-links-json/')
                .then(response => response.json())
                .then(data => {
                    console.log("Fetched links:", data.links);
                    let tableBody = document.querySelector('#linksTable tbody');
                    tableBody.innerHTML = ''; // Clear the table before adding new rows
                    data.links.forEach((url, index) => {
                        addLinkToTable(url);
                    });
                })
                .catch(error => console.error('Error:', error));
        }
    
        function clearTable() {
            let tableBody = document.querySelector('#linksTable tbody');
            tableBody.innerHTML = ''; // Clear the table
        }
    });
</script>

        
        
    <table id="linksTable" class="table">
        <thead>
          <tr>
            <th scope="col">#</th>
            <th scope="col">Link</th>
          </tr>
        </thead>
        <tbody>
          <!-- JavaScript will populate table body -->
        </tbody>
      </table>
      
{% endblock %} 
    
